# Entities Source Generators

## Overview

Source Generators are used in DOTS to enable a number of features inside of DOTS.  Namely:
- Entities.ForEach
- Job.WithCode
- Aspects
- Idiomatic C# `foreach`
- SystemAPI
- IJobEntity

Generators do this by adding new types, methods and partial types.  In specific cases, existing code is also patched with the Cloner IL post-processor (also in the Entities package).

## Don't forget DOTSLab!

When trying to repro a source generation issue, DOTSLab is a great tool that saves a lot of time.
http://dotslab.cds.internal.unity3d.com

## Building Source Generators

Source generator DLLs need to be compiled manually outside of the Unity compilation pipeline using the .NET SDK 6.0 or higher:
https://dotnet.microsoft.com/en-us/download/dotnet/6.0
That can be done with dotnet from within the `Packages\com.unity.entities\Unity.Entities\SourceGenerators\Source~` directory:

`dotnet publish -c Release`

Additionally, they can be built/debugged with the SourceGenerator solution in the same folder.
 
### Debugging with Rider

- Rebuild the generators as debug: `dotnet publish -c Debug`.
- Open `Packages/com.unity.entities/Unity.Entities/SourceGenerators/Source~/SourceGenerators.sln` with Rider.
- Go to the configurations drop-down, select "Edit Configurations...", create a new ".NET Executable" configuration:
  - Open the editor log for the Unity project, look for `##### CommandLine`.
  - Immediately after that should be a line that looks like this:
  - `"<dotnet path>" exec "<csc.dll path>" /nostdlib /noconfig /shared "<rsp path>" "rsp2 path"`
  - Copy the path to csc.dll and put it as the "exe path" in the new configuration.
  - Copy the `<rsp path>` and paste it as "program arguments" (ignore the rsp2).
  - Set the working directory to the root of the Unity project. 

The config should look something like this:
![](codegen_debug_config.png)
You should now be able to run from Rider and set breakpoints.

### CodeGen Output

- Add `DOTS_OUTPUT_SOURCEGEN_FILES` to the "Scripting Define Symbols" of the Unity project.
- The generators will output _copies_ of the source files it generates, along with a log into the `\<UnityProject\>/Temp/GeneratedCode` directory.

### Testing

Every user-facing feature supported by source-generators should have its own unit tests (usually in `Unity.Entities.Tests`).  Additionally, errors need tests and it can be handy to write "verification" tests that compare source-gen output to some pre-recorded "gold" verification file.  Both of these can be done with MSTest tests that run outside of Unity. `Unity.Entities.SourceGenerators.Test` contains a number of these tests.

To check for an error being generated by a string containing the origin source use the following:
`VerifyCS.VerifySourceGeneratorAsync(testSource, expected)`
(where `using VerifyCS = Unity.Entities.SourceGenerators.Test.CSharpSourceGeneratorVerifier<Generator>` is set, 
and `Generator` is the name of the generator, `testSource` is the string containing the origin source and `expected` is the expected diagnostic(s)).

Similarly, it is possible to validate some origin source against a pre-recorded verification output source:
`VerifyCS.VerifySourceGeneratorAsync(testSource, nameof(MyTestingMethod), expectedFileNames)`
If the test fails it will show a diff of the pre-recorded file with the newly generated one. You can set `CSharpSourceGeneratorVerifier<>.k_OverrideSourceOfTruthOnTestThrow` to true to auto-verify every failing test (and update the saved verifications).

All these tests can be run from inside of Rider or with `dotnet test`.

If you want to check what the resulting code looks like when running a unit test, put a breakpoint in `SourceOutputHelpers.OutputSourceToFile` and then call the `sourceTextProvider` function from debugger's immediate window and inspect the return value.

### Tips and Tricks

- `/<UnityProject\>/Temp/GeneratedCode/SourceGen.log` contains more info on source generators running.
- The meta files for generator DLLs must contain the following labels in the meta file, which occasionally get overwritten locally by Unity: 
	- RunOnlyOnAssembliesWithReference
	- SourceGenerator
	- RoslynAnalyzer
